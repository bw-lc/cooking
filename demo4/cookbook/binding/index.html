<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绑定智能锅</title>
    <script src="/cordova.js"></script>
  </head>
  <body>
    <table>
      <tr><td><font size="5">绑定智能锅</font></td></tr>
    </table>

      <div class="statusText"></div> 

    <table border="1">
      <tr>
        <td>扫描</td>
        <td><button onclick=connect();>扫描</button></td>
      </tr>
      <tr>
        <td>mac地址</td>
        <td><input type="text" name="in_index" id="in_index" value="0" /></td>
      </tr>
      <tr>
        <td>后退</td>
        <td><button onclick="javascript:history.go(-1);">后退</button></td>
      </tr>
    </table>

      <div class="statusText2"></div>

  </body>
 
  <script>
require("cordova!cordova-plugin-ble-central");
function showinfo(str) {
  var cb_statusText = document.getElementsByClassName('statusText');
  cb_statusText[0].innerHTML = str;
}

function showinfo2(str) {
  var cb_statusText2 = document.getElementsByClassName('statusText2');
  cb_statusText2[0].innerHTML = str;
}

function errCallBack(info) {
  showinfo("失败：" + JSON.stringify(info));
}

var g_finding;
function finding() {
  g_finding = g_finding - 1;
  if (g_finding > 0) {
    showinfo("正在查找设备，剩余" + g_finding + "秒...");
    setTimeout("finding();", 1000);
  } else {
      showinfo("查找完毕。");
  }
}


function connect() {
  showinfo("正在查找设备，剩余15秒...");
  g_finding = 15;
  ble.scan([], 15, find_ble, errCallBack);
  setTimeout("finding();", 1000);
}

var g_device_id = new Array();
var g_device_i  = 0;

function find_ble(info) {
  dname = info.name;
  rssi = parseInt(info.rssi);
  if (dname.search("bwdcl-") == 0) { // && rssi > -75) {
    showinfo(info.id);
    g_device_id[g_device_i] = info.id;
    g_device_i = g_device_i + 1;

    //str = g_device_id[0];
    //for (i = 1; i < g_device_id.length; i++) {
    //    str = str + "<br>" + g_device_id[i];
    //}
    //showinfo2(str);
    showinfo2(info.name);
  } else {
    showinfo(JSON.stringify(info));
  }
}

  </script>

</html>
